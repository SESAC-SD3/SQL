## 1. 기본 CRUD 쿼리

### 1.1. CREATE (생성)

**새 사용자 등록**
```sql
INSERT INTO users (username, email, password_hash, full_name)
VALUES ('newuser', 'newuser@example.com', 'hash1234', '새유저');
```

**새 게시물 작성**
```sql
-- 1. 게시물 생성
INSERT INTO posts (user_id, content)
VALUES (1, '새로운 게시물 내용입니다');

-- 2. 방금 생성한 게시물의 ID 확인
SELECT LAST_INSERT_ID();

-- 3. 미디어 추가 (post_id = LAST_INSERT_ID())
INSERT INTO media (post_id, media_url, media_type, media_order)
VALUES
    (LAST_INSERT_ID(), 'https://example.com/new1.jpg', 'IMAGE', 1),
    (LAST_INSERT_ID(), 'https://example.com/new2.jpg', 'IMAGE', 2);
```

**댓글 작성**
```sql
INSERT INTO comments (post_id, user_id, content)
VALUES (1, 2, '멋진 게시물이에요!');
```

**좋아요 누르기**
```sql
INSERT INTO likes (post_id, user_id)
VALUES (1, 2);
```

---

### 1.2. READ (조회)

**사용자 프로필 조회**
```sql
SELECT
    user_id,
    username,
    full_name,
    profile_image_url,
    created_at
FROM users
WHERE user_id = 1;
```

**게시물 상세 조회**
```sql
SELECT
    p.post_id,
    u.username,
    u.profile_image_url,
    p.content,
    p.created_at
FROM posts p
JOIN users u ON p.user_id = u.user_id
WHERE p.post_id = 1;
```

---

### 1.3. UPDATE (수정)

**프로필 수정**
```sql
UPDATE users
SET
    full_name = '김철수',
    profile_image_url = 'https://example.com/newprofile.jpg'
WHERE user_id = 1;
```

**게시물 내용 수정**
```sql
UPDATE posts
SET content = '수정된 게시물 내용입니다'
WHERE post_id = 1
    AND user_id = 1;  -- 본인 게시물만 수정 가능
```

**게시물 미디어 관리**
```sql
-- 기존 미디어 삭제
DELETE FROM media
WHERE post_id = 1;

-- 새 미디어 추가
INSERT INTO media (post_id, media_url, media_type, media_order)
VALUES (1, 'https://example.com/updated.jpg', 'IMAGE', 1);
```

**댓글 수정**
```sql
UPDATE comments
SET content = '수정된 댓글입니다'
WHERE comment_id = 1
    AND user_id = 2;  -- 본인 댓글만 수정 가능
```

---

### 1.4. DELETE (삭제)

**좋아요 취소**
```sql
DELETE FROM likes
WHERE post_id = 1
    AND user_id = 2;
```

**댓글 삭제**
```sql
DELETE FROM comments
WHERE comment_id = 1
    AND user_id = 2;  -- 본인 댓글만 삭제 가능
```

**게시물 삭제 (CASCADE로 미디어, 댓글, 좋아요도 함께 삭제)**
```sql
DELETE FROM posts
WHERE post_id = 1
    AND user_id = 1;  -- 본인 게시물만 삭제 가능
```

---

## 2. 핵심 기능 쿼리

### 2.1. 특정 게시물의 모든 댓글 조회

**게시물의 모든 댓글 조회**
```sql
SELECT
    c.comment_id,
    u.username,
    u.profile_image_url,
    c.content,
    c.created_at
FROM comments c
JOIN users u ON c.user_id = u.user_id
WHERE c.post_id = 1
ORDER BY c.created_at;  -- 시간순 정렬
```

**설명:**
- 특정 게시물의 모든 댓글을 작성 시간 순으로 조회
- 사용자 정보와 JOIN하여 작성자 이름과 프로필 이미지 함께 표시

---

### 2.2. 특정 유저가 작성한 모든 게시물

**게시물과 미디어 함께 조회**
```sql
SELECT
    p.post_id,
    p.created_at,
    COUNT(DISTINCT m.media_id) as media_count,
    COUNT(DISTINCT l.like_id) as likes_count,
    COUNT(DISTINCT c.comment_id) as comments_count
FROM posts p
LEFT JOIN media m ON p.post_id = m.post_id
LEFT JOIN likes l ON p.post_id = l.post_id
LEFT JOIN comments c ON p.post_id = c.post_id
WHERE p.user_id = 1
GROUP BY p.post_id, p.created_at
ORDER BY p.created_at DESC;
```



---

### 2.3. 최신 게시물 목록 조회

**모든 사용자의 최신 게시물**
```sql
SELECT
    p.post_id,
    u.user_id,
    u.username,
    u.profile_image_url,
    p.created_at,
    (SELECT media_url FROM media WHERE post_id = p.post_id ORDER BY media_order LIMIT 1) as first_media_url,
    (SELECT COUNT(*) FROM likes WHERE post_id = p.post_id) as likes_count,
    (SELECT COUNT(*) FROM comments WHERE post_id = p.post_id) as comments_count
FROM posts p
JOIN users u ON p.user_id = u.user_id
ORDER BY p.created_at DESC
LIMIT 20;  -- 최신 20개
```



---

### 2.4. 인기 게시물 조회 (좋아요 많은 순)

**최근 7일간 인기 게시물 Top 10**
```sql
SELECT
    p.post_id,
    u.username,
    u.profile_image_url,
    p.content,
    p.created_at,
    COUNT(l.like_id) as likes_count
FROM posts p
JOIN users u ON p.user_id = u.user_id
LEFT JOIN likes l ON p.post_id = l.post_id
WHERE p.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY p.post_id, u.username, u.profile_image_url, p.content, p.created_at
ORDER BY likes_count DESC, p.created_at DESC
LIMIT 10;
```

---

### 2.7. 특정 게시물의 좋아요 누른 사람 목록

```sql
SELECT
    u.user_id,
    u.username,
    u.full_name,
    u.profile_image_url,
    l.created_at as liked_at
FROM likes l
JOIN users u ON l.user_id = u.user_id
WHERE l.post_id = 1
ORDER BY l.created_at DESC;
```

---

### 2.8. 특정 사용자의 통계 정보

```sql
SELECT
    u.user_id,
    u.username,
    u.full_name,
    (SELECT COUNT(*) FROM posts WHERE user_id = u.user_id) as posts_count,
    (SELECT COUNT(*) FROM likes l JOIN posts p ON l.post_id = p.post_id WHERE p.user_id = u.user_id) as total_likes_received
FROM users u
WHERE u.user_id = 1;
```

---

### 2.9. 게시물별 댓글 수 통계

```sql
SELECT
    p.post_id,
    u.username,
    p.content,
    COUNT(c.comment_id) as comments_count
FROM posts p
JOIN users u ON p.user_id = u.user_id
LEFT JOIN comments c ON p.post_id = c.post_id
GROUP BY p.post_id, u.username, p.content
HAVING comments_count > 0
ORDER BY comments_count DESC;
```

---

### 2.10. 유저별 게시물 수 통계

```sql
SELECT
    u.user_id,
    u.username,
    u.full_name,
    COUNT(p.post_id) as posts_count,
    MAX(p.created_at) as last_post_at
FROM users u
LEFT JOIN posts p ON u.user_id = p.user_id
GROUP BY u.user_id, u.username, u.full_name
ORDER BY posts_count DESC;
```

---

### 2.11. 최근 활동 조회 (댓글 + 좋아요)

**특정 사용자의 최근 활동 타임라인**
```sql
-- 댓글 활동
SELECT
    'comment' as activity_type,
    c.comment_id as activity_id,
    p.post_id,
    u_post.username as post_author,
    c.content as activity_content,
    c.created_at
FROM comments c
JOIN posts p ON c.post_id = p.post_id
JOIN users u_post ON p.user_id = u_post.user_id
WHERE c.user_id = 1

UNION ALL

-- 좋아요 활동
SELECT
    'like' as activity_type,
    l.like_id as activity_id,
    p.post_id,
    u_post.username as post_author,
    p.content as activity_content,
    l.created_at
FROM likes l
JOIN posts p ON l.post_id = p.post_id
JOIN users u_post ON p.user_id = u_post.user_id
WHERE l.user_id = 1

ORDER BY created_at DESC
LIMIT 20;
```

---

### 2.12. 활성 사용자 Top 10 (게시물 + 댓글 + 좋아요)

```sql
SELECT
    u.user_id,
    u.username,
    u.full_name,
    (SELECT COUNT(*) FROM posts WHERE user_id = u.user_id) as posts_count,
    (SELECT COUNT(*) FROM comments WHERE user_id = u.user_id) as comments_count,
    (SELECT COUNT(*) FROM likes WHERE user_id = u.user_id) as likes_count,
    (
        (SELECT COUNT(*) FROM posts WHERE user_id = u.user_id) +
        (SELECT COUNT(*) FROM comments WHERE user_id = u.user_id) +
        (SELECT COUNT(*) FROM likes WHERE user_id = u.user_id)
    ) as total_activity
FROM users u
ORDER BY total_activity DESC
LIMIT 10;
```

---

### 2.13. 일별 게시물 수 통계

```sql
SELECT
    DATE(created_at) as date,
    COUNT(*) as posts_count
FROM posts
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

---

### 2.14. 좋아요를 가장 많이 받은 사용자 Top 5

```sql
SELECT
    u.user_id,
    u.username,
    u.full_name,
    COUNT(l.like_id) as total_likes
FROM users u
JOIN posts p ON u.user_id = p.user_id
LEFT JOIN likes l ON p.post_id = l.post_id
GROUP BY u.user_id, u.username, u.full_name
ORDER BY total_likes DESC
LIMIT 5;
```

---

### 2.15. 특정 사용자가 좋아요한 게시물 목록

```sql
SELECT
    p.post_id,
    u.username as post_author,
    p.content,
    l.created_at as liked_at
FROM likes l
JOIN posts p ON l.post_id = p.post_id
JOIN users u ON p.user_id = u.user_id
WHERE l.user_id = 1  -- 로그인 사용자
ORDER BY l.created_at DESC;
```

---

### 2.16. 게시물 상세 정보 (미디어 포함)

```sql
SELECT
    p.post_id,
    u.username,
    u.profile_image_url,
    p.created_at,
    m.media_url,
    m.media_type,
    m.media_order
FROM posts p
JOIN users u ON p.user_id = u.user_id
LEFT JOIN media m ON p.post_id = m.post_id
WHERE p.post_id = 1
ORDER BY m.media_order;
```

---

## 3. 고급 쿼리

### 3.1. 윈도우 함수 활용

**각 사용자의 게시물 순위 (좋아요 기준)**
```sql
SELECT
    p.post_id,
    u.username,
    p.created_at,
    COUNT(l.like_id) as likes_count,
    RANK() OVER (PARTITION BY u.user_id ORDER BY COUNT(l.like_id) DESC) as rank_in_user
FROM posts p
JOIN users u ON p.user_id = u.user_id
LEFT JOIN likes l ON p.post_id = l.post_id
GROUP BY p.post_id, u.username, p.created_at, u.user_id
ORDER BY u.username, rank_in_user;
```

---

### 3.2. 트랜잭션 (게시물 작성)

```sql
START TRANSACTION;

-- 1. 게시물 생성
INSERT INTO posts (user_id)
VALUES (1);

SET @post_id = LAST_INSERT_ID();

-- 2. 미디어 추가
INSERT INTO media (post_id, media_url, media_type, media_order)
VALUES
    (@post_id, 'https://example.com/tx1.jpg', 'IMAGE', 1),
    (@post_id, 'https://example.com/tx2.jpg', 'IMAGE', 2);

-- 3. 확인
SELECT * FROM posts WHERE post_id = @post_id;
SELECT * FROM media WHERE post_id = @post_id;

-- 4. 커밋 또는 롤백
COMMIT;
-- ROLLBACK;
```


